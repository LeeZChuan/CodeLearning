### 前情提要
1. Vue 项目 整体打包的概念
2. 当浏览器访问一个链接的时候是怎么找到对应页面的js和css的？
3. 访问一个链接，如：[https://pcserver.compass.cn/favicon.ico](https://pcserver.compass.cn/favicon.ico) 的概念
4. nginx的概念
5. 端口的概念
6. 目前我们的测试服务器的部署做法。（还可以有别的做法。类似线上服务器的）
7. 线上服务器的部署做法
8. 怎么在一台服务器上创建多个项目的测试环境

### 1  Vue 项目 整体打包的概念

首先明确一个概念，就是浏览器在展示网页的时候最根本的就是解析三种类型的代码：html 标签，css样式，js代码。
所以无论市面上出现多少种框架，Vue，React， Angular，Koa，egg，php，还有一些ssr（服务器渲染）的Next，Nuxt，最终呈现给浏览器的就是三样，html，css，js。
也就是说不管是在.vue文件里还是在.tsx里写，最终打包就只会生成三种文件，.html .css .js。

说一下Vue项目打包的整个流程：

1. 当我们执行 npm run build 打包命令，程序会从index.html入口开始，识别到文件引用到了main.ts，这个就是我们常说的Vue的入口文件，但其实真正的入口文件是项目目录下的index.html。
2. 在index.html文件中，可以看到创建了一个id="app"的div（这个很重要），并且引用了个script标签，链接到了main.ts文件中。
3. 在main.ts中，import了很多组件和三方库，在这里引用都是全局的，引用到的所有代码最终会打包到一个js文件中，一般在做Vue首屏加载速度优化的时候主要就是优化这个文件的引用资源大小问题。
```js
const app = createApp(App);
...
app.use(router);
...
app.mount('#app');
```

在这个文件中最重要的就是这几行了，首先创建了一个app，Vue概念里的单页面应用，然后把这个app挂在到了一个id="app"的div上，就是index.html文件里的那个div。这样一整套项目代码就会入口就完善了。

![[Pasted image 20240731140822.png]]
通过这个入口 Vite会检索整个项目所有用到的文件和代码，按照Vue的语法规则编译成一个个css和js文件，并且通过我们配置的router，将这一个个js和css关联起来。



### 2 当浏览器访问一个链接的时候是怎么找到对应页面的js和css的？

比如：访问 http://localhost:8080/dataCenter/dtRankHome 

其实Vue项目里访问任何链接都是先访问的dist/index.html文件，链接的入口文件，注意和上面打包的index.html文件做区分，那个是打包入口文件。（也是『单页面应用』的由来，因为整个项目其实就一个html文件，就是index.html文件）
- 首先加载红框的index.js文件，根据/index.js文件里的逻辑判断继续引用哪个页面对应的js文件；
- 然后加载出页面来；
- 页面也都是由js生成的；
- 所以能做到所谓的Vue动态加载

![[Pasted image 20240806202546.png]]



### 3 访问一个链接，如：**[https://pcserver.compass.cn/favicon.ico](https://pcserver.compass.cn/favicon.ico) 的概念**

我们在浏览器输入[https://pcserver.compass.cn/favicon.ico](https://pcserver.compass.cn/favicon.ico) ，到浏览器打开这张图片，都发生了什么？

1. 首先浏览器需要将[https://pcserver.compass.cn](https://pcserver.compass.cn/favicon.ico) 域名做DNS解析，查询到服务器的ip地址，DNS解析：包括浏览器缓存查询，本机缓存查询，DNS服务器的递归查询，具体不细说了。

2. 查找到ip地址后，就会创建tcp链接，如果是https还会在三次握手的成功后再做一次SSL或者TSL握手校验（4次握手），保证数据传输的安全。https的"s"就是这个意思。

3. 然后通过建立好的链接发送http请求，请求具体的资源。

4. 服务器收到请求后根据请求的链接返回对应的响应数据 。

这里有个问题，比如favicon.ico图片是放在/data/web/dist/文件夹的，正常应该访问连接 [https://pcserver.compass.cn/data/web/dist/favicon.ico](https://pcserver.compass.cn/favicon.ico)才能拿到图片资源，那为什么现在访问 [https://pcserver.compass.cn/favicon.ico](https://pcserver.compass.cn/favicon.ico)也可能拿到资源呢？

这就需要用到nginx了。

### 4 Nginx是什么？

服务器代理（反向代理）

 **1.** **应对高并发连接**

在 2000 年代初期，Igor Sysoev 面临着处理高并发连接的挑战。许多传统的 web 服务器（如 Apache）在处理大量并发连接时会遇到性能瓶颈。这些服务器通常使用线程或进程来处理每个连接，这在高并发环境下会导致大量的系统资源消耗和性能下降。

Nginx 采用了事件驱动、异步非阻塞的处理模型，允许它高效地处理大量并发连接，而不会因为每个连接都需要一个独立的线程或进程而导致资源浪费。

**2.** **性能优化**

Nginx 的设计初衷之一是优化性能。它专注于提供高效的静态内容服务，并能迅速处理大量的请求。Nginx 通过以下几个方面提高了性能：

**事件驱动架构**：Nginx 使用事件驱动的模型来处理连接，允许单个进程处理多个连接，而不需要为每个连接创建一个新的线程或进程。

**异步处理**：Nginx 采用非阻塞 I/O 操作，使得处理请求时不会被单个连接阻塞，从而提升了处理速度。

**高效的资源管理**：Nginx 通过减少系统资源的使用（如内存和 CPU），提高了整体的系统性能。

 **3.** **高可靠性**

Nginx 旨在提供一个稳定和可靠的服务器平台。它的设计强调了高可用性和故障恢复能力，使得在面对流量激增或硬件故障时，能够保持服务的连续性。

 **4.** **反向代理和负载均衡**

**反向代理服务器，处理来自客户端的请求并将其转发到后端服务器，同时还能对请求进行负载均衡，分配到不同的服务器上，从而提高了系统的可扩展性和负载能力。**

##### **前端项目主要使用到nginx功能就是反向代理能力。 简单说一下nginx.conf文件中的一些参数**


### **5 端口的概念**

1. 什么是端口？

在计算机网络中，端口是一个逻辑上的概念，它表示通信的端点。可以理解成电脑上的一个个usb+hdmi+dp+充电口等等。每个端口都有一个唯一的端口号，用于标识网络连接中的特定进程或服务。端口号范围从 0 到 65535。

2. 端口号的分类

· **知名端口号（Well-Known Ports）**：范围从 0 到 1023，这些端口号通常分配给系统级的服务和应用程序，例如 HTTP（80 端口）、HTTPS（443 端口）、FTP（21 端口）、SSH（22 端口）等。

· **注册端口号（Registered Ports）**：范围从 1024 到 49151，这些端口号通常分配给用户进程或特定的应用程序，例如 MySQL 数据库（3306 端口）、PostgreSQL 数据库（5432 端口）等。

· **动态/私有端口号（Dynamic/Private Ports）**：范围从 49152 到 65535，这些端口号通常分配给客户端进程或临时使用，例如在 NAT 设备上用于映射内部 IP 和端口。

3. 端口的用途

端口的主要用途是帮助网络设备区分和管理不同的网络服务。一个服务器可以通过多个端口同时提供多种服务。例如，一个服务器可以同时运行一个 Web 服务器（使用 80 或 443 端口）和一个邮件服务器（使用 25、110、143 端口）。

4. 如何工作 

当客户端向服务器发送请求时，必须指定目标服务器的 IP 地址和端口号。服务器根据端口号将请求路由到对应的服务进程。以下是一个简化的工作流程：

**客户端请求**：客户端发起一个网络请求，指定目标服务器的 IP 地址和端口号（例如，访问 [http://localhost:8081/hello.html](http://localhost:8081/hello.html) 会请求 8081 端口对应的服务）。

**服务器监听**：服务器上的相应服务（如 Web 服务器）在指定端口（如 8081 端口）上监听传入请求。 

**建立连接**：服务器接收到请求后，与客户端建立连接，处理请求并返回响应数据。

**关闭连接**：完成数据传输后，双方可以选择关闭连接。

5. 端口和安全性

端口管理对于网络安全至关重要。未正确配置或暴露的端口可能成为攻击的目标。以下是一些常见的安全措施：

**关闭未使用的端口**：确保只有必要的端口处于开放状态，减少潜在的攻击面。

**使用防火墙**：通过防火墙规则控制进出网络的流量，限制对特定端口的访问。

**端口转发和 NAT**：在路由器或防火墙上配置端口转发和网络地址转换（NAT），保护内部网络。

### **6 目前我们的测试服务器的部署做法**

基本上通过上述的了解，就可以大概了解了一个前端项目的页面是怎么在浏览器里被打开了。

剩下的就是怎么把vue打包好的dist文件夹里的内容放到服务器上。

目前我们测试服务器的做法是:

1. 直接在服务器上git clone一个项目

2.切换对应的测试分支，npm run build ，打包好dist文件夹。

3.nginx.conf 配置指定dist目录

4.启动nginx服务。

第3步第4步通常第一次部署完成后就不需要再做了，之后发布就只做1、2即可。

### **7 线上服务器的部署做法**

首先在一台代理服务器上做 上述 五的做法，然后将dist文件夹压缩成一个压缩包，然后将压缩包发送到线上服务器，并解压到指定目录中。

其实测试服务器可以用类似的做法，就是在自己本地开发，开发完成后，直接本地npm run build打包，然后将dist压缩，然后使用scp命令或者使用FTP文件传输等方式将压缩包复制到测试服务器里的指定目录下并解压即可。适合单人开发。

多人开发，需要在服务器上配置每个人的ssh-key，就是ssh授权，scp需要用到。又或者在服务器上搭建FTP服务，然后本地安装FTP软件上传文件。比较麻烦。然后管理容易混乱，不知道谁什么时候就发一个包上去。甚至不知道测试服务器上的代码是哪个版本的，谁写的，谁发布的等等。


### **8 怎么在一台服务器上创建多个项目的测试环境**

到上面一个完整的前端项目就部署完成了，那怎么在同一个服务器上部署多个项目的测试环境？

其实用到的就是nginx的反向代理能力，在nignx.conf 配置文件中创建多个server， 每个服务监听不同的端口，指定不同的访问目录即可。查看当前端口的使用情况：lsof -i -P -n |grep nginx


# **小知识：Vue项目部署的一个重点，没有这一步，访问链接时候会发现访问不通。**

[http://localhost:8080/dataCenter/dtRankDetail?code=605180&market=SHHQ&name=%E5%8D%8E%E7%94%9F%E7%A7%91%E6%8A%80&theme=dark](http://localhost:8080/dataCenter/dtRankDetail?code=605180&market=SHHQ&name=%E5%8D%8E%E7%94%9F%E7%A7%91%E6%8A%80&theme=dark)

比如当我们访问这个链接时，按照正常逻辑是访问   /Users/huangyuchen/Documents/compass/stock/web/dist/dataCenter/dtRankDetail/index.html 文件，但实际上我们在打包dist文件夹时是没有这个文件的，都是打包出来的 js和css文件。

这时候需要用到 try_files $uri $uri/  /index.html;